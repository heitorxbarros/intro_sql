---
title: "Introdução a bases de dados e SQL"
subtitle: "Parte 3"
author: "Heitor Barros"
institute: "FP/SUBGGC/CGRH/CTAP"
date: ""
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    css: xaringan-themer.css
---
class: center, middle
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#004b80", 
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono"),
)
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "logo.png",
  position = xaringanExtra::css_position(top = "1em", right = "1em"),
  width = "200px"
)

```

# GROUP BY E FUNÇÕES DE GRUPO
---
class: inverse, center, middle

# Agregando conjuntos de dados

---
## GROUP BY

A agregação de dados é a criação de algum tipo de total ou resumo a partir de vários registros. Soma, mínimo, máximo, contagem e média são algumas das operações de agregação mais comuns. Podemos realizar essas operações sobre qualquer coluna especificada, o que nos permite controlar facilmente o escopo das agregações.

---
### FUNÇÕES DE GRUPO

**Exemplo 1:** Contabilizando todos os registros de uma tabela coma função **COUNT**.  
```{sql eval = F}
SELECT COUNT(*) 
FROM ERGON.VINCULOS;
```

.pull-left[
A função **COUNT** é usada para contabilizar registros em uma consulta. Também pode ser utilizada em consultas que possuem a cláusula **WHERE**.  
]
.pull-right[
```{r echo=FALSE, out.width="90%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO.png")
```
]

---
### FUNÇÕES DE GRUPO

**Exemplo 2:** Contabilizando registros de uma tabela por grupos usando **COUNT** e **GROUP BY**.  
```{sql eval = F}
SELECT EMP_CODIGO, COUNT(*) 
FROM ERGON.VINCULOS 
GROUP BY EMP_CODIGO 
ORDER BY 1;
```

.pull-left[
A cláusula **GROUP BY** pode ser combinada com a função **COUNT** para recuperar o total de registros agrupados por determinada coluna. O formato resultante é conhecido como *tabulação* e conta a quantidade de valores unicos para cada grupo. A *posição relativa* pode ser usada na cláusula **GROUP BY** da mesma forma que foi utilizada para ordenar os registros na cláusula **ORDER BY**.
]
.pull-right[
```{r echo=FALSE, out.width="80%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO2.png")
```
]

---
### FUNÇÕES DE GRUPO

**Exemplo 3:** Contabilizando registros únicos de uma coluna por grupos usando **DISTINCT**.  
.pull-left[
```{sql eval = F}
SELECT 
  EMP_CODIGO
  , COUNT(*) AS REGISTROS
  , COUNT(NUMFUNC) AS TOTAL_FUNCIONARIOS
  , COUNT(DISTINCT NUMFUNC) FUNCIONARIOS  
FROM ERGON.VINCULOS 
GROUP BY EMP_CODIGO 
ORDER BY 1;
```


Por padrão, o SGBD contabiliza todos os registros não nulos de uma coluna ao usar a função **COUNT**. Se desejamos contabilizar os valores únicos, devemos usar a palavra-chave **DISTINCT** antes do nome da coluna e dentro dos parênteses da função **COUNT**.
]

.pull-right[
```{r echo=FALSE, out.width="100%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO3.png")
```
]

---
### COMENTANDO O CÓDIGO

**Exemplo 4:** Impedindo a execução de parte do código.  
```{sql eval = F}
SELECT 
  EMP_CODIGO  
  --, COUNT(*) AS REGISTROS
  --, COUNT(NUMFUNC) AS TOTAL_FUNCIONARIOS
  , COUNT(DISTINCT NUMFUNC) FUNCIONARIOS  -- Conta o total de funcionários únicos
FROM ERGON.VINCULOS 
GROUP BY EMP_CODIGO 
ORDER BY 1;
/* Estas linhas 
não serão executadas */
```
.pull-left[
Ao digitar uma consulta, pode ser útil escrever um comentário explicando o código. Podemos, também, estar interessados em que parte do código não seja executado naquele momento. Podemos usar os símbolos **"--"**. Todo código posicionado entre **"--"** e o final da linha serão ignorados (não serão executados). Para comentar múltiplas linhas, usamos os simbolos **"/*"** e **"/*"**. Tudo que estiver contido entre eles será ignorado.
]
.pull-right[
```{r echo=FALSE, out.width="60%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO3.png")
```
]

---
### FUNÇÕES DE GRUPO
**Exemplo 5:** Somando e calculando a média de registros por grupo usando **SUM** e **AVG**.
```{sql eval = F}
SELECT EMP_CODIGO, SUM(VALOR), AVG(VALOR)
FROM ERGON.FICHAS_FINANCEIRAS 
WHERE MES_ANO_FOLHA = '01/09/2023' AND NUM_FOLHA = 1 AND RUBRICA = 996
GROUP BY EMP_CODIGO 
ORDER BY 1;
```


```{r echo=FALSE, out.width="80%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO3.png")
```
---
### FUNÇÕES DE GRUPO
**Exemplo 6:** Calculando valores máximos e mínimos de registros por grupo usando **MAX** e **MIN**.
```{sql eval = F}
SELECT EMP_CODIGO, MAX(VALOR), MIN(VALOR)
FROM ERGON.FICHAS_FINANCEIRAS 
WHERE MES_ANO_FOLHA = '01/09/2023' AND NUM_FOLHA = 1 AND RUBRICA = 996
GROUP BY EMP_CODIGO 
ORDER BY 1;
```


```{r echo=FALSE, out.width="80%", fig.align='center', dpi=600}
knitr::include_graphics("images/FUNCOES_DE_GRUPO3.png")
```
